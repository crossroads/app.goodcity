#!/bin/bash

site_folder=/var/www/html/app.goodcity.hk

echo "Setting variable APP_SHA"
APP_SHA=$(git rev-parse --short HEAD 2> /dev/null)
if [ $? -ne 0 ]; then
  APP_SHA=$(hg parent --template '{gitnode}' | cut -c1-7)
fi
export APP_SHA

APP_SHARED_SHA=$(git ls-remote --heads https://github.com/crossroads/shared.goodcity.git master | cut -c1-7)
export APP_SHARED_SHA

echo "Building $site [$environment]"
EMBER_CLI_CORDOVA=0 ember build --environment=$environment
if [ $? -ne 0 ]; then
  exit 1
fi

echo "Uploading new files to $site"
release_folder=$site_folder/releases/$(date +%s)

for port in ${ports//,/ }
do
  ssh -p $port deployer@$site "mkdir -p $site_folder/releases"

  rsync -e "ssh -p $port" -rz dist/* deployer@$site:$release_folder

  ssh -p $port deployer@$site "ln -nfs $release_folder $site_folder/current"

  # keep most recent 3 release directories
  ssh -p $port deployer@$site "cd $site_folder/releases && ls -dvr */ | tail -n +4 | xargs rm -rf"
done
